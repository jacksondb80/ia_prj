<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Chat com IA</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Chat */
        #chat {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #ffffff;
            border-bottom: 1px solid #ccc;
        }

        .msg {
            margin-bottom: 10px;
        }

        .user {
            font-weight: bold;
            color: #333;
            white-space: pre-wrap;
        }

        .ai {
            color: #0077cc;
        }

        /* Estilos para o Markdown renderizado da IA */
        .ai p {
            margin: 5px 0;
        }

        .ai ul,
        .ai ol {
            margin: 5px 0;
            padding-left: 20px;
        }

        .ai img {
            max-width: 200px;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .ai a {
            color: #0056b3;
            text-decoration: underline;
        }

        .ai strong {
            font-weight: 700;
        }

        /* Área de escrita */
        #input-area {
            padding: 10px;
            background: #eee;
            display: flex;
            gap: 10px;
        }

        textarea {
            flex: 1;
            resize: none;
            padding: 10px;
            font-size: 14px;
        }

        button {
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div id="chat"></div>

    <div id="input-area">
        <textarea id="text" rows="3" placeholder="Escreva sua mensagem..."></textarea>
        <button onclick="send()">Enviar</button>
    </div>

    <script>
        const chat = document.getElementById('chat');
        const textArea = document.getElementById('text');
        // Gera um ID de sessão dinâmico a cada refresh da página
        const sessionId = 'sess' + Date.now() + Math.random().toString(36).substring(2, 9);

        // Envia mensagem ao pressionar Enter (sem Shift)
        textArea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); // Impede a criação de uma nova linha
                send();
            }
        });

        function addMessage(text, className, label) {
            const div = document.createElement('div');
            div.className = 'msg ' + className;

            // Se for IA, usa marked para converter Markdown em HTML (links, imagens, negrito)
            // Se for usuário, mantém texto puro (o CSS .user cuida das quebras de linha)
            let content = className === 'ai' ? marked.parse(text) : text;

            // Se for mensagem da IA, força os links a abrirem em nova aba
            if (className === 'ai') {
                content = content.replace(/<a /g, '<a target="_blank" rel="noopener noreferrer" ');
            }

            div.innerHTML = `<strong>${label}:</strong> <div>${content}</div>`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function showTyping() {
            const div = document.createElement('div');
            div.className = 'msg ai';
            div.id = 'typing-indicator';
            div.innerHTML = `<strong>IA:</strong> <em>Digitando...</em>`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function removeTyping() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function send() {
            const text = textArea.value.trim();
            if (!text) return;

            addMessage(text, 'user', 'Você');
            textArea.value = '';
            showTyping();

            try {
                const response = await fetch('/chat', {
                    //const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // Usa o ID de sessão dinâmico
                    body: JSON.stringify({ message: text, session_id: sessionId })
                });

                removeTyping();
                const data = await response.json();
                addMessage(data.answer, 'ai', 'IA');

            } catch (err) {
                removeTyping();
                addMessage('Erro ao conectar com o servidor.', 'ai', 'IA');
            }
        }
    </script>



</body>

</html>